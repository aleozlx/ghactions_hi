name: Code-owner Approval Status
on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: read
  statuses: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            // Parse CODEOWNERS (reuse your existing file)
            const fs = require('fs');
            const codeowners = fs.readFileSync('.github/CODEOWNERS', 'utf8')
              .split('\n').filter(l => l.trim() && !l.startsWith('#'))
              .map(l => { const [pattern, ...owners] = l.split(/\s+/); return { pattern, owners }; });

            // HACK const { minimatch } = require('minimatch'); // npm install in a prior step
            const minimatch = (filepath, pattern) => {
              const p = pattern.replace(/\*\*/g, '').replace(/\*/g, '');
              return filepath.startsWith(p);
            };

            // Union all owners across all touched files
            const allOwners = new Set();
            for (const f of files) {
              let lastMatch = null;
              for (const rule of codeowners) {
                if (minimatch(f.filename, rule.pattern)) lastMatch = rule;
              }
              if (lastMatch) lastMatch.owners.forEach(o => allOwners.add(o.replace('@', '')));
            }
            
            // HACK Fallback if no patterns matched at all
            const prAuthor = context.payload.pull_request.user.login;
            const FALLBACK_OWNERS = ['aleozlx']; // change to your leads
            if (allOwners.size === 0 || (allOwners.size === 1 && allOwners.has(prAuthor))) {
              FALLBACK_OWNERS.forEach(o => allOwners.add(o));
            }

            const approved = reviews.some(r =>
              r.state === 'APPROVED' && allOwners.has(r.user.login)
            );

            const owners_array = Array.from(allOwners);
            const display = owners_array.length <= 3
              ? owners_array.map(o => `@${o}`).join(', ')
              : `@${owners_array.slice(0, 3).join(', @')} +${owners_array.length - 3} more`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner, repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: approved ? 'success' : 'failure',
              context: 'codeowner-approval',
              description: approved
                ? `Approved by ${reviews.find(r => r.state === 'APPROVED' && allOwners.has(r.user.login)).user.login}`
                : `‚ùå need approval: ${display}`,
            });
            
